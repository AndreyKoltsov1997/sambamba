<tool id="sambamba_filter" name="Filter BAM or SAM" version="0.2.3">
    <requirements>
        <requirement type="package">sambamba</requirement>
    </requirements>
    <description>
		on flags, fields, and tags
    </description>
    <command>
        #if $query != None:
			#set $query = $query.replace('__sq__', '\'')
			#set $query = $query.replace('__ob__', '[')
			#set $query = $query.replace('__cb__', ']')
			#set $query = $query.replace('__dq__', '"')
			#set $query = $query.replace('__oc__', '{')
			#set $query = $query.replace('__cc__', '}')
			#set $query = $query.replace('__gt__', chr(62))
			#set $query = $query.replace('__lt__', chr(60))
		#end if
		#if $outputformat.format == 'bam':
			#set $header = ''
		#else
			#set $header = $outputformat.header
		#end if
        #if isinstance($input.datatype, $__app__.datatypes_registry.get_datatype_by_extension('bam').__class__):
            #set $input1 = 'input.bam'
            ln -s $input $input1 &amp;&amp;
            ln -s $input.metadata.bam_index input.bai &amp;&amp;
			sambamba view --filter="$query" -f $outputformat.format -o $outfile $input1 $header $region
		#else
            sambamba view -S --filter="$query" -f $outputformat.format -o $outfile $input $header
        #end if
    </command>
    <inputs>
        <param name="input" type="data" format="bam,sam" label="BAM or SAM file to filter"/>
        <param name="query" type="text" size="80">
            <label>Filter expression</label>
        </param>
     
        <conditional name="outputformat">
			<param name="format" type="select">
				<label>Output format</label>
				<option value="sam">SAM</option>
				<option value="bam">BAM</option>
			</param>
			<when value="sam">
				<param name="header" type="select">
					<label>Include SAM header in output</label>
					<option value="-h">Yes</option>
					<option value="">No</option>
				</param>
			</when>
			<when value="bam"/>
        </conditional>
        <param name="region" type="text" size="40" label="Region in format chr:beg-end, works for BAM input only"/>
    </inputs>
    <outputs>
		<data name="outfile" format="bam">
			<change_format>
				<when input="outputformat.format" value="sam" format="sam"/>
			</change_format>	
		</data>
    </outputs>
    <!-- TODO: help -->
    <!-- TODO: tests -->
</tool>
